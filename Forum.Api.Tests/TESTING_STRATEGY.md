# Forum.Api 测试方案文档

> **版本**: 1.0  
> **日期**: 2025-08-28  
> **技术栈**: ASP.NET Core 8 + MySQL + Dapper + SignalR  
> **测试框架**: xUnit + FluentAssertions + Moq + Testcontainers

## 1. 测试策略概述

### 1.1 测试目标
- **功能完整性**：确保所有 API 端点按规范正确工作
- **数据安全性**：验证认证、授权、输入验证和 XSS/CSRF 防护
- **性能基准**：API 响应时间 P95 < 200ms，实时通信延迟 < 1s
- **系统稳定性**：并发场景、异常处理、边界条件测试
- **业务连续性**：核心业务流程的端到端验证

### 1.2 测试金字塔模型

```
        E2E 测试 (10%)
    ────────────────────
   集成测试 (20%)
  ────────────────────────
 单元测试 (70%)
──────────────────────────
```

- **单元测试 (70%)**：服务层逻辑、Repository 数据访问、工具类
- **集成测试 (20%)**：API 端点、数据库交互、外部依赖
- **E2E 测试 (10%)**：关键业务流程、实时通信、用户场景

### 1.3 质量门禁标准
- **代码覆盖率**：≥ 80% (单元测试), ≥ 70% (集成测试)
- **性能基准**：API P95 < 200ms, SignalR P95 < 1s
- **安全扫描**：无高危和中危漏洞
- **功能回归**：核心功能 100% 通过
- **文档一致性**：API 行为与规范文档一致

## 2. 测试分层架构

### 2.1 单元测试层 (Unit Tests)

#### 2.1.1 Services 层测试
**目标**：验证业务逻辑正确性，与外部依赖解耦

**测试范围**：
- `AuthService`: 注册、登录、JWT 生成、密码验证、邮箱验证
- `TopicService`: 主题 CRUD、权限控制、统计更新
- `PostService`: 帖子 CRUD、Markdown 处理、@提及解析
- `CategoryService`: 分类管理、权限验证
- `TagService`: 标签管理、slug 生成
- `SignalRService`: 消息广播、房间管理
- `UserService`: 用户管理、角色权限

**测试要点**：
- 正常流程：所有输入参数有效时的预期行为
- 异常处理：无效输入、权限不足、资源不存在
- 边界条件：空值、极限值、特殊字符
- 业务规则：发帖限制、编辑时间窗口、权限继承

#### 2.1.2 Repositories 层测试
**目标**：验证数据访问逻辑和 SQL 查询正确性

**测试范围**：
- `UserRepository`: 用户 CRUD、角色查询、邮箱验证状态
- `TopicRepository`: 主题分页、筛选、统计更新、关联查询
- `PostRepository`: 帖子分页、回复关系、@提及查询
- `CategoryRepository`: 分类层次、排序、统计
- `TagRepository`: 标签关联、使用统计
- `RefreshTokenRepository`: Token 存储、过期清理

**测试要点**：
- SQL 语法正确性：参数化查询、索引使用
- 分页逻辑：Keyset 分页、游标处理、边界情况
- 事务处理：数据一致性、回滚机制
- 并发控制：乐观锁、版本冲突检测
- 性能优化：查询效率、N+1 问题避免

#### 2.1.3 Infrastructure 层测试
**目标**：验证基础设施组件功能

**测试范围**：
- `JwtTokenService`: JWT 生成、验证、过期处理
- `PasswordService`: 密码哈希、验证、强度检查
- `EmailService`: 邮件发送、模板渲染、错误处理
- `DatabaseMigrator`: 迁移执行、版本管理

### 2.2 集成测试层 (Integration Tests)

#### 2.2.1 API 控制器测试
**目标**：验证 HTTP 端点完整行为，包括请求处理、响应格式、状态码

**测试范围**：
- `AuthController`: `/api/v1/auth/*` 认证相关端点
- `TopicsController`: `/api/v1/topics/*` 主题管理端点
- `PostsController`: `/api/v1/topics/*/posts/*` 帖子管理端点
- `CategoriesController`: `/api/v1/categories/*` 分类管理端点
- `TagsController`: `/api/v1/tags/*` 标签管理端点

**测试要点**：
- HTTP 状态码：200, 201, 400, 401, 403, 404, 409, 500
- 请求验证：参数校验、Content-Type、CSRF Token
- 响应格式：统一 ApiResponse 结构、错误信息
- 认证授权：JWT 验证、角色权限、资源所有权
- 分页处理：cursor 参数、limit 限制、meta 信息

#### 2.2.2 数据库集成测试
**目标**：验证与真实数据库的交互行为

**测试环境**：
- **Testcontainers MySQL**：隔离的 MySQL 容器实例
- **测试数据准备**：预设用户、分类、主题、帖子数据
- **数据清理**：每个测试后清理数据，避免污染

**测试场景**：
- 事务一致性：发帖时统计字段更新的原子性
- 外键约束：级联删除、参照完整性
- 索引效果：分页查询、全文搜索性能
- 并发处理：多用户同时操作的数据一致性

#### 2.2.3 SignalR Hub 测试
**目标**：验证实时通信功能

**测试场景**：
- 连接建立：客户端连接、认证、断开重连
- 房间管理：加入主题房间、离开房间、多房间
- 消息广播：帖子创建/编辑/删除事件广播
- 用户状态：正在输入指示、在线状态更新
- 权限控制：未认证用户、权限不足的操作限制

### 2.3 端到端测试层 (E2E Tests)

#### 2.3.1 关键业务流程测试
**目标**：模拟真实用户操作，验证完整业务链路

**测试场景**：
- **用户注册流程**：注册 → 邮箱验证 → 首次登录 → 创建首帖
- **社区互动流程**：浏览主题 → 回帖 → @提及 → 收到通知 → 编辑帖子
- **内容管理流程**：创建分类 → 创建主题 → 打标签 → 移动主题 → 置顶锁定
- **实时通信流程**：多用户同时在线 → 实时收到新帖 → 显示输入状态
- **搜索发现流程**：关键词搜索 → 筛选结果 → 跳转到具体楼层

## 3. 核心功能测试用例设计

### 3.1 认证授权系统

#### 3.1.1 用户注册 (POST /api/v1/auth/register)
**正常流程测试**：
- 有效注册信息提交成功
- 邮箱验证邮件正确发送
- 重复邮箱注册被拒绝
- 用户名唯一性验证

**异常场景测试**：
- 无效邮箱格式
- 密码强度不符要求  
- 用户名包含特殊字符
- 请求体缺失必填字段

**安全性测试**：
- XSS 攻击防护（用户名、邮箱）
- SQL 注入尝试
- 暴力注册防护（限流）

#### 3.1.2 用户登录 (POST /api/v1/auth/login)
**正常流程测试**：
- 正确凭据登录成功
- JWT Token 正确生成
- Refresh Token 存储
- HttpOnly Cookie 设置

**异常场景测试**：
- 错误密码
- 不存在的邮箱
- 未验证邮箱用户
- 被封禁用户登录

**安全性测试**：
- 暴力破解防护
- 会话固定攻击防护
- CSRF Token 验证

### 3.2 内容管理系统

#### 3.2.1 主题创建 (POST /api/v1/topics)
**正常流程测试**：
- 完整主题信息创建成功
- Markdown 内容正确处理
- 标签关联建立
- 分类统计更新

**权限验证测试**：
- 未认证用户创建被拒绝
- 未验证邮箱用户创建被拒绝
- 被封禁用户操作被拒绝

**数据完整性测试**：
- 事务原子性：主题和首帖同时创建
- 外键一致性：分类ID、标签ID 有效性
- 统计准确性：分类主题数、标签使用数

#### 3.2.2 帖子回复 (POST /api/v1/topics/:topicId/posts)
**正常流程测试**：
- 回帖内容正确保存
- @提及用户解析和通知
- 主题统计实时更新
- SignalR 消息广播

**业务规则测试**：
- 锁定主题禁止回帖
- 删除主题禁止回帖
- 回复引用关系建立
- Markdown 渲染和 XSS 过滤

### 3.3 实时通信系统

#### 3.3.1 SignalR 房间管理
**连接测试**：
- 用户成功连接到 Hub
- JWT 认证有效性验证
- 自动重连机制
- 连接超时处理

**房间操作测试**：
- 加入主题房间成功
- 离开房间清理
- 多房间并行管理
- 权限控制（私有主题）

#### 3.3.2 实时消息广播
**事件广播测试**：
- PostCreated: 新帖创建广播
- PostEdited: 帖子编辑广播  
- PostDeleted: 帖子删除广播
- TopicStats: 统计更新广播
- UserTyping: 输入状态广播

**性能要求测试**：
- 消息延迟 P95 < 1s
- 并发用户连接 (100+ 用户)
- 消息丢失率 < 0.1%

### 3.4 搜索功能系统

#### 3.4.1 全文搜索 (GET /api/v1/search)
**搜索准确性测试**：
- 主题标题搜索
- 帖子内容搜索
- 组合搜索结果排序
- 分类和标签筛选

**搜索性能测试**：
- 响应时间 < 500ms
- 大数据集搜索效率
- FULLTEXT 索引效果
- 搜索结果分页

## 4. 数据管理策略

### 4.1 测试数据构建

#### 4.1.1 数据构建器模式 (Builder Pattern)
**用途**：创建测试所需的各种实体对象

**构建器类型**：
- `UserTestDataBuilder`: 创建不同角色的用户
- `TopicTestDataBuilder`: 创建各种状态的主题
- `PostTestDataBuilder`: 创建回帖和引用关系
- `CategoryTestDataBuilder`: 创建分类层次结构
- `TagTestDataBuilder`: 创建标签和关联关系

#### 4.1.2 测试夹具 (Test Fixtures)
**基础夹具**：
- `DatabaseFixture`: 数据库容器管理和连接
- `AuthenticatedUserFixture`: 预认证用户上下文
- `CategoryHierarchyFixture`: 完整分类结构
- `SampleContentFixture`: 示例主题和帖子内容

### 4.2 数据隔离策略

#### 4.2.1 数据库隔离
- **容器隔离**：每个测试类使用独立的 MySQL 容器
- **事务回滚**：单个测试在事务中执行，完成后回滚
- **数据清理**：测试完成后删除测试数据
- **Schema 重置**：定期重新创建数据库 Schema

#### 4.2.2 并行执行支持
- **Collection 分组**：按功能模块分组，避免资源冲突
- **端口动态分配**：测试容器端口自动分配
- **临时文件管理**：测试生成文件的独立存储和清理

### 4.3 外部依赖 Mock

#### 4.3.1 邮件服务 Mock
- **SMTP 模拟**：使用 MailHog 或 MailDev 测试邮件
- **邮件内容验证**：验证邮件模板和链接有效性
- **发送失败模拟**：测试邮件服务异常处理

#### 4.3.2 第三方 API Mock
- **HTTP Mock Server**：模拟外部服务响应
- **网络异常模拟**：超时、连接失败场景
- **响应延迟模拟**：测试超时处理机制

## 5. 性能与安全测试

### 5.1 性能基准测试

#### 5.1.1 API 性能基准
**目标指标**：
- 单个 API 响应时间 P95 < 200ms
- 吞吐量：1000 QPS (并发场景)
- 内存使用：< 500MB (正常负载)
- CPU 使用率：< 70% (峰值负载)

**测试场景**：
- 主题列表查询性能
- 复杂搜索查询性能
- 大量并发用户登录
- 实时消息广播性能

#### 5.1.2 数据库性能测试
**查询优化验证**：
- 索引使用效果验证
- 分页查询性能测试
- 全文搜索性能基准
- 事务处理性能测试

### 5.2 安全性测试

#### 5.2.1 输入验证安全
**XSS 防护测试**：
- Markdown 内容 XSS 尝试
- 用户输入字段 XSS 测试
- HTML 消毒效果验证
- 脚本注入防护测试

**SQL 注入防护**：
- 所有用户输入点注入尝试
- 参数化查询有效性验证
- 动态 SQL 安全检查

#### 5.2.2 认证授权安全
**JWT 安全测试**：
- Token 伪造尝试
- Token 过期处理
- Refresh Token 安全性
- 会话劫持防护

**权限控制测试**：
- 垂直权限提升尝试
- 水平权限绕过测试
- 资源访问权限验证
- 批量操作权限控制

## 6. 测试环境配置

### 6.1 本地开发环境

#### 6.1.1 依赖安装
```bash
# 安装测试框架和工具包
dotnet add package xunit
dotnet add package FluentAssertions  
dotnet add package Moq
dotnet add package Testcontainers.MySql
dotnet add package Microsoft.AspNetCore.Mvc.Testing
```

#### 6.1.2 配置文件
- `appsettings.Test.json`: 测试专用配置
- `testcontainers.properties`: 容器配置
- `xunit.runner.json`: 测试运行器配置

### 6.2 CI/CD 环境

#### 6.2.1 GitHub Actions 配置
**测试管道阶段**：
1. **环境准备**：安装 .NET SDK、Docker
2. **依赖安装**：恢复 NuGet 包
3. **单元测试**：运行快速单元测试
4. **集成测试**：启动测试容器，运行集成测试
5. **覆盖率报告**：生成和上传覆盖率报告
6. **质量门禁**：检查覆盖率和测试通过率

#### 6.2.2 测试报告
- **覆盖率报告**：Codecov 集成
- **测试结果**：JUnit XML 格式
- **性能报告**：BenchmarkDotNet 集成
- **安全扫描**：SAST 工具集成

## 7. 测试执行计划

### 7.1 里程碑测试计划

#### M1: 认证系统测试
- 用户注册、登录、邮箱验证
- JWT Token 生成和验证
- 权限控制基础功能
- **验收标准**：认证 API 100% 通过，安全测试无高危漏洞

#### M2: 内容管理测试  
- 主题和帖子 CRUD 功能
- Markdown 渲染和 XSS 防护
- 分类和标签系统
- **验收标准**：内容 API 95% 通过，性能达到基准要求

#### M3: 搜索功能测试
- 全文搜索准确性和性能
- 筛选和排序功能
- 搜索结果分页
- **验收标准**：搜索响应时间 < 500ms，结果准确率 > 95%

#### M4: 实时通信测试
- SignalR 连接和房间管理
- 消息广播准确性和延迟
- 并发用户支持
- **验收标准**：消息延迟 P95 < 1s，支持 100+ 并发用户

#### M5: 通知系统测试
- @提及通知准确性
- 通知状态管理
- 邮件通知集成
- **验收标准**：通知触发准确率 100%，邮件送达率 > 95%

#### M6: 系统集成测试
- 完整业务流程测试
- 性能压力测试
- 安全性全面验证
- **验收标准**：E2E 测试 100% 通过，满足所有性能和安全要求

### 7.2 回归测试策略

#### 7.2.1 自动化回归测试
**执行频率**：
- **每日构建**：单元测试 + 集成测试核心用例
- **代码提交**：快速烟雾测试
- **版本发布前**：完整回归测试套件
- **生产部署后**：健康检查测试

#### 7.2.2 回归测试范围
**核心功能回归**：
- 用户认证和权限控制
- 主题和帖子基本操作
- 搜索和筛选功能
- 实时消息广播

**性能回归**：
- API 响应时间基准
- 数据库查询性能
- 并发处理能力
- 内存和 CPU 使用

### 7.3 测试度量和报告

#### 7.3.1 测试覆盖率度量
**代码覆盖率**：
- 行覆盖率：≥ 80%
- 分支覆盖率：≥ 75%  
- 方法覆盖率：≥ 90%

**功能覆盖率**：
- API 端点覆盖：100%
- 业务场景覆盖：≥ 95%
- 错误场景覆盖：≥ 80%

#### 7.3.2 质量指标跟踪
**缺陷统计**：
- 测试发现缺陷率
- 生产环境逃逸缺陷率
- 缺陷修复时间分布

**性能趋势**：
- API 响应时间趋势
- 测试执行时间趋势
- 资源使用量趋势

## 8. 测试维护和优化

### 8.1 测试代码质量

#### 8.1.1 测试代码规范
**命名约定**：
- 测试类：`{ClassName}Tests`
- 测试方法：`{MethodName}_{Scenario}_{ExpectedResult}`
- 测试数据：`Given{Condition}_When{Action}_Then{Result}`

**代码组织**：
- Arrange-Act-Assert 模式
- 单一职责测试
- 测试数据外部化
- 公共测试工具提取

#### 8.1.2 测试维护策略
**定期维护**：
- 清理过时的测试用例
- 更新测试数据和场景
- 重构重复的测试代码
- 优化慢速测试用例

**测试债务管理**：
- 识别和修复脆弱测试
- 提高测试执行稳定性
- 减少测试维护成本

### 8.2 持续改进

#### 8.2.1 测试效率优化
**执行时间优化**：
- 并行执行优化
- 测试数据准备优化
- 容器启动时间优化
- 测试用例分组优化

**资源使用优化**：
- 内存使用优化
- 数据库连接池管理
- 临时文件清理
- 网络资源释放

#### 8.2.2 测试覆盖率提升
**盲点识别**：
- 代码覆盖率分析
- 业务场景缺口分析
- 边界条件遗漏检查
- 错误处理路径验证

**新功能测试**：
- 新 API 端点测试
- 业务规则变更测试
- 性能影响评估测试
- 安全性影响测试

## 9. 风险管理

### 9.1 测试风险识别

#### 9.1.1 技术风险
**环境依赖风险**：
- 数据库版本兼容性
- 容器环境差异
- 网络环境变化
- 第三方服务依赖

**数据风险**：
- 测试数据污染
- 敏感数据泄露
- 数据一致性问题
- 大数据量测试限制

#### 9.1.2 业务风险
**功能回归风险**：
- 核心业务功能破坏
- 性能显著下降
- 安全漏洞引入
- 用户体验恶化

**发布延迟风险**：
- 测试执行时间过长
- 缺陷修复周期长
- 测试环境不稳定
- 人力资源不足

### 9.2 风险缓解策略

#### 9.2.1 技术风险缓解
**环境标准化**：
- Docker 容器标准化
- 基础设施即代码
- 配置管理自动化
- 版本依赖锁定

**数据保护**：
- 测试数据脱敏
- 敏感信息加密
- 数据访问审计
- 清理机制自动化

#### 9.2.2 业务风险缓解
**质量保证**：
- 多层次测试验证
- 渐进式功能发布
- 快速回滚机制
- 实时监控告警

**效率提升**：
- 测试用例优先级分级
- 关键路径重点保障
- 自动化程度提升
- 团队技能培训

## 10. 总结

本测试方案文档为 Forum.Api 项目提供了全面的测试策略和实施指南，涵盖了从单元测试到端到端测试的完整测试体系。通过遵循本方案的指导原则和最佳实践，可以确保系统的功能完整性、性能可靠性和安全稳定性，为产品的成功交付提供坚实的质量保障。

关键成功因素：
- **全面覆盖**：功能、性能、安全性测试全方位覆盖
- **自动化驱动**：CI/CD 集成，持续验证代码质量
- **数据驱动**：基于度量和指标的持续改进
- **风险可控**：主动识别和管控测试和业务风险
- **团队协作**：开发、测试、运维团队紧密配合

通过持续执行和优化本测试方案，将建立起高效、可靠的测试体系，支撑论坛系统的长期稳定发展。